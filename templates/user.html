<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auction System - Welcome, {{ user }}!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --play-purple: #7B21BA;
            --play-purple-hover: #6618A1;
            --play-light-purple: #F5F0FF;
            --play-border-radius: 16px;
            --panel-bg: #FAFAFA;
            --mini-panel-bg: #F8F9FD;
            --text-dark: #1A1A1A;
            --table-header-bg: #F0F2F5;
        }

        body {
            background-color: #F8F9FA;
            font-family: 'Open Sans', sans-serif;
            padding: 2rem;
            color: var(--text-dark);
        }

        .container {
            max-width: 2200px;
            margin: 0 auto;
        }

        h1, h2, h3, .welcome-title {
            font-family: 'Playfair Display', serif;
            color: var(--text-dark);
            font-weight: 700;
        }

        .welcome-panel {
            background-color: var(--mini-panel-bg);
            padding: 32px;
            border-radius: var(--play-border-radius);
            margin-bottom: 32px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: background-color 0.3s ease;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 16px;
        }

        .welcome-description {
            font-size: 18px;
            color: #666;
            margin-top: 16px;
            line-height: 1.6;
        }

        .three-column-layout {
            display: flex;
            gap: 32px;
        }

        .left-column, .middle-column, .right-column {
            background-color: white;
            padding: 24px;
            border-radius: var(--play-border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .left-column {
            width: 300px;
        }

        .middle-column {
            flex: 1;
        }

        .right-column {
            width: 600px;
        }

        .table {
            border-radius: var(--play-border-radius);
            overflow: hidden;
        }

        .table th {
            background-color: var(--table-header-bg);
            color: var(--text-dark);
            font-weight: 600;
            padding: 16px;
            border: none;
        }

        .table td {
            padding: 16px;
            border-color: #E5E5E5;
        }

        .btn-primary {
            background-color: var(--play-purple);
            border-color: var(--play-purple);
        }

        .btn-primary:hover {
            background-color: var(--play-purple-hover);
            border-color: var(--play-purple-hover);
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #c82333;
        }

        .alert-info {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: #495057;
            border-radius: var(--play-border-radius);
            padding: 16px;
        }

        .fixed-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .fixed-panel-item {
            background-color: var(--mini-panel-bg);
            padding: 1rem;
            border-radius: var(--play-border-radius);
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        /* Custom light colors for table rows */
        .table-active {
            background-color: #f5f0ff; /* Light purple */
        }

        .table-warning {
            background-color:rgb(250, 3, 3); /* Light yellow */
        }

        .table-danger {
            background-color: #fff3cd; /* Light yellow */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Panel with Log Out Button -->
        <div class="welcome-panel" id="welcomePanel">
            <div class="welcome-title" id="welcomeMessage">Welcome, {{ user }}!</div>
            <p class="welcome-description">Participate in the auction by placing bids on available blocks.</p>
            <form action="{{ url_for('logout') }}" method="post" class="logout-button">
                <button type="submit" class="btn btn-danger">Log Out</button>
            </form>
        </div>

        <!-- Three-Column Layout -->
        <div class="three-column-layout">
            <!-- Left Column: User Panel -->
            <div class="left-column">
                <div class="section">
                    <h2>User Panel</h2>

                    <!-- Fixed Panel for Auction Status, Current Round, and Bid Information -->
                    <div class="fixed-panel">
                        <!-- Auction Status -->
                        <div class="fixed-panel-item">
                            <h4>Auction status:</h4>
                            <p>{{ auction_data['status'] }}</p>
                        </div>

                        <!-- Current Round -->
                        <div class="fixed-panel-item">
                            <h4>Round:
                            {{ auction_data['current_round'] }}</h4>
                        </div>

                        <!-- Time Left in Round -->
                        <div class="fixed-panel-item">
                            <h4>Seconds left:</h4>
                            <p><span id="timer" class="fw-bold text-danger">{{ remaining_time }}</span> </p>
                        </div>

                        <!-- Bid Information -->
                        <div class="fixed-panel-item">
                            <h4>Bid Information</h4>
                            <p class="{% if (2 - auction_data['current_leaders'].values() | select('equalto', user) | list | length) > 0 %}bg-warning{% else %}bg-success{% endif %}">
                                You have {{ 2 - auction_data['current_leaders'].values() | select('equalto', user) | list | length }} bids.
                            </p>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Middle Column: Auction Table -->
            <div class="middle-column">
                <div class="section">
                    <h2>Auction Table</h2>
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Block</th>
                                <th>Bids in Last Round</th>
                                <th class="start-price-column">Start Price [PLN]</th>
                                <th>Bid Percentage [%]</th>
                                <th>Bid Increment [PLN]</th>
                                <th class="bid-amount-column">Bid Amount [PLN]</th>
                                <th>Bid</th>
                                <th>Are You Bidding?</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for block, data in auction_data['block_data'].items() %}
                                {% set is_winning = auction_data['current_leaders'][block] == user %}
                                {% set has_bid_on_block = block in auction_data['bid_block_list'][user] %}
                                {% set can_bid = auction_data['status'] == 'running' and (2 - auction_data['bid_block_list'][user] | length) > 0 and not is_winning and not has_bid_on_block %}
                                {% set cannot_bid = auction_data['status'] != 'running' or (2 - auction_data['bid_block_list'][user] | length) <= 0 or is_winning or has_bid_on_block %}
                        
                                <tr class="
                                    {% if is_winning %}table-active{% endif %}
                                    {% if can_bid %}table-warning{% endif %}
                                    {% if cannot_bid %}table-danger{% endif %}
                                ">
                                    <td>{{ block }}</td>
                                    <td>{{ data['bids_last_round'] }}</td>
                                    <td id="start_price_{{ block }}" class="start-price-column">{{ data['start_price'] | format_price }}</td>
                                    <td>
                                        <form action="{{ url_for('place_bid') }}" method="post" class="d-flex">
                                            <input type="hidden" name="user" value="{{ user }}">
                                            <input type="hidden" name="block" value="{{ block }}">
                                            <select name="bid_percentage" class="form-select me-2 bg-transparent" id="bid_percentage_{{ block }}" onchange="updateBidDetails('{{ block }}')">
                                                <option value="2" selected>2%</option>
                                                <option value="4">4%</option>
                                                <option value="6">6%</option>
                                                <option value="8">8%</option>
                                                <option value="10">10%</option>
                                            </select>
                                        
                                    </td>
                                    <td id="bid_increment_{{ block }}">{{ data['default_bid_increment']|format_price }}</td>
                                    <td id="bid_amount_{{ block }}" class="bid-amount-column">{{ data['default_bid_amount']|format_price }}</td>
                                    <td>
                                        <button type="submit" class="btn btn-primary {% if cannot_bid %}d-none{% endif %}">
                                            <i class="fas fa-gavel"></i> Bid
                                        </button>
                                    </form>
                                    </td>
                                    <td>{% if is_winning %}Yes{% else %}No{% endif %}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

<!-- Right Column: My Bids and Budget -->
<div class="right-column">
    <!-- Existing sections (My Bids and Budget) -->
    <div class="section">
        <h2>Current Round bids</h2>
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Block</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for bid in user_bids %}
                    <tr>
                        <td>{{ bid['round'] }}</td>
                        <td>{{ bid['block'] }}</td>
                        <td>{{ bid['amount']|format_price }}</td>
                        <td>
                            {% if bid['is_success'] == 'skipped' %}
                                Skipped
                            {% elif bid['is_success'] == 'yes' %}
                                Successful
                            {% else %}
                                Pending
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Budget Section -->
    <div class="section">
        <h2>Budget</h2>
        <div class="alert alert-info">
            <strong>{{ current_sum | format_price }}</strong>
        </div>
    </div>

    <!-- New Section: Bid Block List -->
    <div class="section">
        <h2>Your Bids in Current Round</h2>
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Blocks Bid On</th>
                </tr>
            </thead>
            <tbody>
                {% for user, blocks in auction_data['bid_block_list'].items() %}
                    <tr>
                        <td>{{ user }}</td>
                        <td>
                            {% if blocks %}
                                {{ blocks | join(', ') }}
                            {% else %}
                                No bids yet
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

    <!-- Footer -->
    <footer class="bg-light text-center py-3 mt-4">
        <p>&copy; 2025 Auction System | Powered by marcin.szymanski2@play.pl</p>
    </footer>

    <!-- Timer Script -->
    <script>
        let timer = document.getElementById('timer');
        let welcomePanel = document.getElementById('welcomePanel');
        let welcomeMessage = document.getElementById('welcomeMessage');

        // Function to fetch auction status and remaining time
        function fetchAuctionStatus() {
            fetch("{{ url_for('check_status') }}")
                .then(response => response.json())
                .then(data => {
                    const remainingTime = data.remaining_time;
                    const auctionStatus = data.status;

                    // Update the timer display
                    updateTimer(remainingTime);

                    // Update the Welcome Panel
                    updateWelcomePanel(remainingTime, auctionStatus);

                    // Reload the page if the auction status changes
                    if (auctionStatus !== "{{ auction_data['status'] }}") {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error fetching auction status:', error));
        }

        // Function to update the timer display
        function updateTimer(remainingTime) {
            if (remainingTime > 0) {
                timer.textContent = remainingTime + ' seconds';
            } else {
                timer.textContent = 'Time is up!';
            }
        }

        // Function to update the Welcome Panel
        function updateWelcomePanel(remainingTime, auctionStatus) {
            if (auctionStatus === 'running') {
                const bidsLeft = {{ 2 - auction_data['current_leaders'].values() | select('equalto', user) | list | length }};

                if (bidsLeft > 0) {
                    if (remainingTime <= 15) {
                        // Last 15 seconds
                        welcomePanel.style.backgroundColor = '#ffcccc'; // Light red
                        welcomeMessage.textContent = "{{ user }}, this is your last chance! You have {{ bidsLeft }} bid left.";
                    } else {
                        // User has bids left
                        welcomePanel.style.backgroundColor = '#ffffcc'; // Light yellow
                        welcomeMessage.textContent = "{{ user }}, you can still use your bids.";
                    }
                } else {
                    // User has no bids left
                    welcomePanel.style.backgroundColor = '#f8f9fa'; // Default color
                    welcomeMessage.textContent = "Welcome, {{ user }}. You have used your bids!";
                }
            } else {
                // Auction is not running
                welcomePanel.style.backgroundColor = '#f8f9fa'; // Default color
                welcomeMessage.textContent = "Welcome, {{ user }}!";
            }
        }

        // Fetch auction status and remaining time every second
        setInterval(fetchAuctionStatus, 1000);

        // Initial call to set the correct state when the page loads
        fetchAuctionStatus();

        // Existing functions (keep them as they are)
        function formatPrice(price) {
            return price.toLocaleString('pl-PL', { minimumFractionDigits: 0 });
        }

        function extractNumericValue(price) {
            const cleaned = price.replace(/&nbsp;/g, '')
                                 .replace(/[^0-9.,-]/g, '')
                                 .replace(/\s/g, '')
                                 .replace(/,/g, '');
            return parseFloat(cleaned);
        }

        function updateBidDetails(block) {
            const startPriceElement = document.getElementById(`start_price_${block}`);
            const bidPercentageElement = document.getElementById(`bid_percentage_${block}`);
            const bidAmountElement = document.getElementById(`bid_amount_${block}`);
            const bidIncrementElement = document.getElementById(`bid_increment_${block}`);

            if (startPriceElement && bidPercentageElement && bidAmountElement && bidIncrementElement) {
                const startPrice = extractNumericValue(startPriceElement.innerText);
                const bidPercentage = parseFloat(bidPercentageElement.value);
                const bidIncrement = startPrice * (bidPercentage / 100);
                const bidAmount = startPrice + bidIncrement;

                bidIncrementElement.innerText = formatPrice(bidIncrement);
                bidAmountElement.innerText = formatPrice(bidAmount);
            } else {
                console.error('One or more elements not found', { startPriceElement, bidPercentageElement, bidAmountElement, bidIncrementElement });
            }
        }

        function checkLogoutStatus() {
            fetch('/check_logout_status')
                .then(response => response.json())
                .then(data => {
                    if (data.logout_all) {
                        window.location.href = "{{ url_for('index') }}";
                    }
                });
        }

        setInterval(checkLogoutStatus, 1000);
    </script>
</body>
</html>